{{ $accessRequest := .accessRequest }}
{{ $showActions := .showActions }}
{{ $appID := .appID }}
{{ $credID := .credID }}
{{ $pendingPlan := .pendingPlan }}
{{ $hasPending := .hasPending }}
{{ $isAuthToken := .isAuthToken }}

<div class="col-lg-12 requests-row-section p-3">
  <div class="d-flex justify-content-between p-3">
    <div>
      <h5 class="heading-small text-default m-0">API products and plan access</h5>
      <p class="text-regular-14">API Products and plan this credential can access</p>
    </div>
    {{ if $showActions }}
      <a class="btn btn-secondary-outline" href="/portal/catalogue-products">
        Browse API products to add
      </a>
    {{ end }}
  </div>

  <div class="p-3">
    {{ range $accessRequest.Products }}
      {{ $productPath := .Path }}
      <div class="card-section d-flex justify-content-between align-items-center mb-2">
        <a href="/portal/catalogue-products/{{ $productPath }}" class="text-regular-14 text-default-subdue mt-1">{{ .Name }}</a>
        {{ if and $showActions (gt (len $accessRequest.Products) 1) }}
          <button type="button"
                  class="btn-icon"
                  data-toggle="modal"
                  data-target="#remove-product-{{ .ID }}"
                  aria-label="Remove {{ .Name }}">
            <i class="tyk-icon tykon tykon-delete mt-1"></i>
          </button>
        {{ end }}
      </div>
    {{ end }}
  </div>

  {{ if and $showActions (gt (len $accessRequest.Products) 1) }}
    <!-- Confirmation modals for product removal -->
    {{ range $accessRequest.Products }}
      {{ render "confirmation_modal" (dict
        "id" (printf "remove-product-%d" .ID)
        "title" (printf "Remove %s from this credential" .Name)
        "body" (raw "<p>You are about to remove this API Product from the selected credentials. Once removed:</p><ul><li>The credentials will no longer have access to this API Product.</li><li>Any existing integrations using this API Product may stop working.</li><li>Associated rate limits, quotas, or usage tied to this API Product will no longer apply.</li></ul><p>Do you want to proceed?</p>")
        "confirmText" "Remove API Product"
        "confirmClass" "btn-secondary-outline"
        "cancelText" "Cancel"
        "cancelClass" "btn-secondary-link"
        "formAction" (printf "/portal/private/apps/%d/access-requests/%d/products" $accessRequest.ClientID $accessRequest.ID)
        "formMethod" "post"
        "useForm" true
        "hiddenFields" (dict "product_id" .ID "mode" "delete")
      ) }}
    {{ end }}
  {{ end }}

  {{ if and $accessRequest.Plan $accessRequest.Plan.Name }}
  <div class="d-flex justify-content-between p-3">
    <div class="d-flex" style="gap: 1rem;">
      <!-- Current Plan Card -->
      <div class="basic-card p-4" style="min-width: 250px;">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h4 class="heading-medium text-default mb-0">{{ $accessRequest.Plan.Name }}</h4>
          <span class="pill text-regular-12">Current</span>
        </div>
        <h6 class="heading-xsmall mb-0">Quota: {{ $accessRequest.Plan.FormatQuota }}</h6>
        <h6 class="heading-xsmall">Rate limit: {{ $accessRequest.Plan.FormatRateLimit }}</h6>
      </div>

      <!-- Pending Plan Card (if exists) -->
      {{ if $pendingPlan }}
      <div class="basic-card disabled p-4" style="min-width: 250px;">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h4 class="heading-medium text-default mb-0">{{ $pendingPlan.Name }}</h4>
          <span class="badge badge-yellow text-regular-12 p-1">
            Pending
          </span>
        </div>
        <h6 class="heading-xsmall mb-0">Quota: {{ $pendingPlan.FormatQuota }}</h6>
        <h6 class="heading-xsmall">Rate limit: {{ $pendingPlan.FormatRateLimit }}</h6>
      </div>
      {{ end }}
    </div>

    <!-- Change Plan Button (hidden if pending or authToken credential)
         TODO: authToken hidden temporarily until plan change flow is fully supported for auth tokens -->
    {{ if and $showActions (not $hasPending) (not $isAuthToken) }}
      <button type="button" class="btn btn-secondary-outline" data-toggle="modal" data-target="#change-plan-{{ $credID }}">
        Change Plan
      </button>
    {{ end }}
  </div>
  {{ end }}
</div>
