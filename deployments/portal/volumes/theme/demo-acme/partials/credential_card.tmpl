{{ $cred := .cred }}
{{ $app := .app }}
{{ $isPending := .isPending }}
{{ $appCerts := .appCerts }}
{{ $allCerts := .allCerts }}
{{ $index := .index }}
{{ $pendingPlan := .pendingPlan }}
{{ $hasPending := .hasPending }}

{{ $credID := "" }}
{{ $alias := "" }}
{{ $isCustom := false }}
{{ $accessRequest := "" }}
{{ $dateValue := "" }}

{{ if $isPending }}
  {{ $credID = printf "%d" $cred.ID }}
  {{ if ne $index nil }}
    {{ $alias = printf "Access Request %d" (add $index 1) }}
  {{ else }}
    {{ $alias = printf "Access Request %d" $cred.ID }}
  {{ end }}
  {{ $accessRequest = $cred }}
  {{ $dateValue = ($cred.CreatedAt | date "2 Jan, 2006") }}
{{ else }}
  {{ $credID = $cred.ID }}
  {{ if $cred.Alias }}
    {{ $alias = $cred.Alias }}
  {{ else }}
    {{ if ne $index nil }}
      {{ $alias = printf "Credential %d" (add $index 1) }}
    {{ else }}
      {{ $alias = printf "Credential %d" $cred.ID }}
    {{ end }}
  {{ end }}
  {{ if eq $cred.CredentialType "CREDENTIAL_TYPE_CUSTOM" }}
    {{ $isCustom = true }}
  {{ end }}
  {{ $accessRequest = $cred.AccessRequest }}
{{ end }}

<div class="card p-0 mb-4">
  <div class="card-header d-flex flex-row justify-content-between align-items-center px-3 py-4"
       data-toggle="collapse"
       data-target="#credential-{{ $credID }}"
       aria-expanded="false"
       aria-controls="credential-{{ $credID }}"
       style="cursor: pointer;">
    <h3 class="heading-medium text-default m-0">{{ $alias }}</h3>
    <i class="tyk-icon tykon tykon-arrowdown credential-chevron"></i>
  </div>

  <div id="credential-{{ $credID }}" class="collapse">
    {{ if and (not $isPending) (not $isCustom) }}
      <div class="d-flex flex-row justify-content-end cta-btns-wrapper p-3 mr-3 flex-wrap">
        {{ if eq (TypeOfCredential $cred) "oAuth2.0" }}
          <button type="button"
                  class="btn btn-secondary btn-sm mr-3 enable-credential-editing-{{ $cred.ID }}"
                  onclick="enableCredentialEdit({{ $cred.ID }})">
            <i class="tyk-icon tykon tykon-edit mr-2"></i>Edit redirect URLs
          </button>
          <button type="button"
                  class="btn btn-secondary-outline btn-sm mr-3 disable-credential-editing-{{ $cred.ID }} d-none"
                  onclick="cancelCredentialEdit({{ $cred.ID }})">
            Cancel
          </button>
          <button type="button"
                  class="btn btn-secondary btn-sm disable-credential-editing-{{ $cred.ID }} d-none"
                  onclick="saveCredentialEdit({{ $cred.ID }})">
            Save redirect URLs
          </button>
        {{ end }}
        {{ if $cred.Credential }}
          <button type="button"
                  class="btn btn-secondary btn-sm mr-3 enable-credential-editing-{{ $cred.ID }}"
                  data-toggle="modal"
                  data-target="#rotate-{{ $cred.ID }}">
            <i class="tyk-icon tykon tykon-reload mr-2"></i>Rotate credentials
          </button>
        {{ end }}
        <button type="button"
                class="btn btn-secondary btn-sm enable-credential-editing-{{ $cred.ID }}"
                data-toggle="modal"
                data-target="#revoke-{{ $cred.ID }}">
          <i class="tyk-icon tykon tykon-delete mr-2"></i>Revoke credentials
        </button>
      </div>
    {{ end }}

    <div class="card-body d-flex flex-row justify-content-between flex-wrap">
      <div class="row">
        {{ if $isCustom }}
          {{ render "credential_info_row" (dict
            "label" "Key"
            "description" "A unique ID used to identify the application."
            "value" $cred.CredentialKey
            "showCopy" true
            "inputType" "password"
            "isPending" $isPending
            "pendingMessage" "Your key will appear here when approved"
            "showBorder" false
          ) }}
        {{ else }}
          {{ $tokenLabel := "Client ID" }}
          {{ $tokenValue := "" }}
          {{ if not $isPending }}
            {{ if $cred.Credential }}
              {{ $tokenLabel = "Token" }}
              {{ if $cred.CustomKeyID }}
                {{ $tokenValue = $cred.CustomKeyID }}
              {{ else }}
                {{ $tokenValue = $cred.Credential }}
              {{ end }}
            {{ else }}
              {{ $tokenValue = $cred.OAuthClientID }}
            {{ end }}
          {{ end }}

          {{ render "credential_info_row" (dict
            "label" $tokenLabel
            "description" "A unique ID used to identify the application."
            "value" $tokenValue
            "showCopy" true
            "inputType" "password"
            "isPending" $isPending
            "pendingMessage" (printf "Your %s will appear here when approved" (lower $tokenLabel))
            "showBorder" false
          ) }}
        {{ end }}

        {{ if $isCustom }}
          {{ render "credential_info_row" (dict
            "label" "Secret"
            "description" "This is the unique password for the app and auth server, do not share this information."
            "value" $cred.CredentialSecret
            "showCopy" true
            "inputType" "password"
            "isPending" $isPending
            "pendingMessage" "Your secret will appear here when approved"
          ) }}
        {{ else }}
          {{ $secretLabel := "Secret" }}
          {{ $secretValue := "" }}
          {{ if not $isPending }}
            {{ if $cred.Credential }}
              {{ $secretLabel = "Token Hash" }}
              {{ $secretValue = $cred.CredentialHash }}
            {{ else }}
              {{ $secretValue = $cred.OAuthClientSecret }}
            {{ end }}
          {{ end }}

          {{ render "credential_info_row" (dict
            "label" $secretLabel
            "description" "This is the unique password for the app and auth server, do not share this information."
            "value" $secretValue
            "showCopy" true
            "inputType" "password"
            "isPending" $isPending
            "pendingMessage" (printf "Your %s will appear here when approved" (lower $secretLabel))
          ) }}
        {{ end }}

        <div class="col-lg-12 requests-row-section">
          <div class="d-flex flex-row justify-content-between align-items-center flex-wrap p-3 requests-row-section__info">
            <div class="d-flex flex-column pr-3">
              <h6 class="heading-small text-default mr-4 mb-1">
                {{ if $isPending }}Date requested:{{ else }}Expires:{{ end }}
              </h6>
            </div>
            <div class="text-regular-14 mb-1">
              {{ if $isPending }}
                {{ $dateValue }}
              {{ else }}
                {{ $cred.ExpiresAsString }}
              {{ end }}
            </div>
          </div>

          {{ if not $isCustom }}
            <div class="d-flex flex-row justify-content-between align-items-center flex-wrap p-3 requests-row-section__info">
              <div class="d-flex flex-column pr-3">
                <h6 class="heading-small text-default mr-4 mb-1">Auth Method:</h6>
              </div>
              <div class="text-regular-14 mb-1">
                {{ if $isPending }}
                  <span class="pill">{{ $accessRequest.AuthType }}</span>
                {{ else }}
                  <span class="pill">{{ TypeOfCredential $cred }}</span>
                {{ end }}
              </div>
            </div>
          {{ end }}

          {{ if not $isCustom }}
            {{ if or (and $isPending (eq $accessRequest.AuthType "oauth")) (and (not $isPending) (eq (TypeOfCredential $cred) "oAuth2.0")) }}
              <div class="d-flex flex-row justify-content-between align-items-center flex-wrap p-3 requests-row-section__info">
                <div class="d-flex flex-column pr-3">
                  <h6 class="heading-small text-default mr-4 mb-1">Redirect URLs:</h6>
                </div>
                <div class="text-regular-14 mb-1">
                  {{ if $isPending }}
                    <span><i>Will be set when approved</i></span>
                  {{ else }}
                    <div class="credential-redirect-url-static">
                      <span>
                        {{ if $cred.RedirectURI }}
                          {{ $cred.RedirectURI }}
                        {{ else }}
                          <i>No redirect URLs set</i>
                        {{ end }}
                      </span>
                    </div>
                    <div class="credential-redirect-url-edit d-none">
                      <input type="text"
                             name="credential_redirect_url_{{ $cred.ID }}"
                             class="form-control"
                             value="{{ $cred.RedirectURI }}"
                             style="min-width: 300px;">
                      <small class="form-text text-muted">Separate URLs with commas</small>
                    </div>
                  {{ end }}
                </div>
              </div>
            {{ end }}
          {{ end }}

          {{ if not $isCustom }}
            {{ if or (and $isPending (eq $accessRequest.AuthType "oauth")) (and (not $isPending) (eq (TypeOfCredential $cred) "oAuth2.0")) }}
            <div class="col-lg-12 mt-4 mb-4">
              <div class="d-flex flex-column p-3 app-how-to">
                <div class="d-flex align-items-center mb-4">
                  <span><img src="/assets/images/icons/how-to.svg" class="mr-2"></span>
                  <h4 class="heading-small text-default mb-0 ml-2">How to access the API Product(s)</h4>
                </div>
                <div>
                  <ol>
                    <li>Copy paste the client secret and ID in a POST request to the identity provider.</li>
                    <li>Receive an access token issued by the identity provider.</li>
                    <li>Use the access token to gain access to the API product.</li>
                  </ol>
                </div>
                <div>
                  <a href="/docs" target="_blank">
                    Learn more
                    <i class="tyk-icon tykon tykon-link" aria-hidden="true"></i>
                  </a>
                </div>
              </div>
            </div>
            {{ end }}
          {{ end }}
        </div>
      </div>
    </div>

    {{ if and $accessRequest (not $isCustom) }}
      {{ render "credential_products_plan" (dict
        "accessRequest" $accessRequest
        "showActions" (not $isPending)
        "appID" $app.ID
        "credID" $credID
        "pendingPlan" $pendingPlan
        "hasPending" $hasPending
      ) }}
    {{ end }}

    {{ if and (not $isCustom) (not $isPending) $accessRequest (eq $accessRequest.AuthType "multiAuth") }}
      {{ render "mtls_certificate_section" (dict
        "accessRequest" $accessRequest
        "appCerts" $appCerts
        "allCerts" $allCerts
        "appID" $app.ID
        "isPending" $isPending
      ) }}
    {{ end }}

    {{ if not $isCustom }}
      {{ if or (and $isPending (eq $accessRequest.AuthType "oauth")) (and (not $isPending) (eq (TypeOfCredential $cred) "oAuth2.0")) }}
        {{ render "oauth_client_type_info" (dict "cred" $cred "isPending" $isPending) }}
      {{ end }}
    {{ end }}

    {{ if and (not $isCustom) (not $isPending) $accessRequest $accessRequest.AllowSubscriptions }}
      {{ render "webhooks_section" (dict "cred" $cred "app" $app "isPending" $isPending) }}
    {{ end }}
  </div>
</div>

{{ if not $isPending }}
  {{ render "credential_modals" (dict "cred" $cred "app" $app) }}
  {{ if not $isCustom }}
    {{ render "change_plan_modal" (dict "cred" $cred "app" $app "credID" $credID "availablePlans" .availablePlans) }}
  {{ end }}
{{ end }}
