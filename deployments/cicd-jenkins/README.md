# CI/CD Jenkins

CI/CD is demonstrated using Jenkins and Tyk Sync. These provide an automated way of pushing API Definitions and Policies to different Tyk environments.

- [Jenkins Dashboard](http://localhost:8070)
- [Gitea Dashboard](http://localhost:13000)

## Setup

This feature depends on the Tyk Environment 2 deployment, so the two must be deployed together. The `tyk2` parameter should be provided before the `cicd-jenkins` parameter, as the the CI/CD deployment requires some information from the Tyk Environment 2 deployment: 

```
./up.sh tyk2 cicd-jenkins
```

The bootstrap process installs the necessary plugins, adds a job and imports environment credentials into Jenkins. It also installs Gitea and restores a 'tyk-data' repo which Jenkins will use to push deploy Tyk configuration across environments.

> :warning: The bootstrap process for this deployment can take a long time to complete the first time it is run. This is due to the having the download the Jenkins plugins. These are then cached locally to speed up the process for subsequent deployments.

## Usage

After the bootstrap process is complete, the CI/CD functionality can be demonstrated.

### Demo Steps

#### 1. Check That Tyk Environment 2 Has No APIs or Policies

Log into the [Tyk environment 2 Dashboard](http://localhost:3002) (using credentials shown in bootstrap output, and a private browser session to avoid invalidating your session cookie for the default Dashboard). The Dashboard will not contain any data, so there will be no APIs or Policies shown.

Also, because there are no APIs available, the [Tyk environment 2 Gateway](http://localhost:8085/basic-open-api/get) will return 404 responses.

In the ['tyk-data' repo on Gitea](http://localhost:13000/gitea-user/tyk-data), you will see that no Tyk data is present.

In the ['Tyk APIs and Policies' job in Jenkins](http://localhost:8070/job/apis-and-policies/job/master/), you will see that the job has run, but nothing has happened because no Tyk data is present in the repository.

#### 2. Extract API and Policy Definitions From Environment 1 Using Tyk Sync

Run the `dump-tyk.sh` script:

```
./deployments/cicd-jenkins/scripts/dump-tyk.sh
```

This script uses Tyk Sync to extract the API and Policy definitions, and write them to the `tyk-data` git repository directory. This data is then ready to be added, committed and pushed to Gitea, so it can then be consumed by Jenkins.

The `tyk-data` local repository directory is `/tmp/tyk-demo/tyk-data`.

#### 3. Push Updates to the Repository

Run the `push-repo-tyk-data.sh` script:

```
./deployments/cicd-jenkins/scripts/push-repo-tyk-data.sh
```

This will add, commit and push all the changes to the Gitea server.

Check the ['tyk-data' repo on Gitea](http://localhost:13000/gitea-user/tyk-data). You will see that the Tyk data is now present, which means that Jenkins will be able to process it.

#### 4. Run the Jenkins Job To Push the Data Into Tyk Environment 2

Run a build for the ['Tyk APIs and Policies' job in Jenkins](http://localhost:8070/job/apis-and-policies/job/master/). 

Now that Tyk data is present, Jenkins will use Tyk Sync to push the APIs and Policies into Tyk Environment 2. 

#### 5. Check That Tyk Environment 2 Has APIs and Policies

In the [Tyk environment 2 Dashboard](http://localhost:3002), the API and Policy definitions will now be available. 

The [Tyk environment 2 Gateway](http://localhost:8085/basic-open-api/get) will have processed the newly imported data, and will now be able to process API requests.

### Rerunning the Synchronisation Process

To further demonstrate this process you can essentially rerun the demo steps, but change the data in Tyk environment 1 first:

1. Change some API configuration in the Tyk environment 1 Dashboard
2. Run the `dump-tyk.sh` script
3. Run the `push-repo-tyk-data.sh` script
4. Run the Jenkins job
5. Check that the data has updated in the Tyk environment 2 Dashboard

## Changing Gitea Configuration

Gitea's configuration is restored using a Gitea archive file during the bootstrap process. This is generated by Gitea and contains its configuration and repository data.

The Gitea archive is stored in this repo as `deployments/cicd-jenkins/volumes/gitea/gitea-dump.zip`. It can be updated by using the `deployments/cicd-jenkins/scripts/dump-gitea.sh`, which will run the necessary command within the Gitea container and copy the resulting archive to overwrite the file in this repo. This updated file can then be committed.

## Changing Jenkins Configuration

Changes to Jenkins configuration via the user interface are stored in the Jenkins configuration files, which are located within the container at `/var/jenkins_home/`.

- The main Jenkins configuration is stored in the `config.xml` file
- Each plugin has its own configuration file e.g. the NodeJS configuration is in the `jenkins.plugins.nodejs.tools.NodeJSInstallation.xml` file
- Each job has its own directory and configuration file e.g. the APIs and Policys job is in the `config.xml`, which is located within the `jobs/apis-and-policies` directory

Tyk Demo stores the equivilent configuration files locally in `deployments/cicd-jenkins/volumes/jenkins/bootstrap-import`. These files are then used by the `bootstrap.sh` script to set the configuration during deployment initialisation.

## Notable Functionality

### Commit Trigger

When a commit is made to the git repo, Gitea makes a webhook call to Jenkins that triggers the build process.

For this to work, the Gitea makes a request to Jenkins using this URL http://jenkins:8080/git/notifyCommit?url=http://gitea:13000/gitea-user/tyk-data, which contains the repository URL as a parameter. When Jenkins receives this type of request it will trigger jobs to build if they match two conditions:

1. The job *repository URL* matches the `url` value passed by the webhook
2. The job *build trigger* is configured to use *Poll SCM*

Note that although the Poll SCM option is enabled, the configuration should be left emtpy, as we don't want Jenkins to actually poll the git repo on a schedule. This would be inefficient, and defeats the point of dynamic webhook approach. However, Jenkins still needs to poll for change, but only when triggered to do so by the webhook, so the empty configuration will allow it to do that, but without making repetitive and unnecessary poll requests.

### Integration Testing

The Jenkins job is configured to execute tests as part of the build process. To do this, it uses the Newman test runner to run the tests in the repo Postman collection. This is performed via a shell command:

```
newman run tyk_demo_cicd_jenkins.postman_collection.json
```