---
name: Tyk Demo API Tests (Parallel)
on:
  workflow_dispatch:
    inputs:
      gateway_debug:
        description: 'Enable Gateway debug logging'
        required: false
        type: boolean
        default: false
      dashboard_debug:
        description: 'Enable Dashboard debug logging'
        required: false
        type: boolean
        default: false
  push:

jobs:
  # First job to collect all the deployments to test
  discover-deployments:
    runs-on: ubuntu-latest
    outputs:
      deployment-matrix: ${{ steps.set-matrix.outputs.deployment-matrix }}
      gateway-tag: ${{ steps.get-gateway-tag.outputs.gateway-tag }}
    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@v4

      - name: Find All Deployments
        id: set-matrix
        run: |
          DEPLOYMENTS=$(find deployments -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | jq -R -s -c 'split("\n") | map(select(length > 0)) | sort')

          if [ "${#DEPLOYMENTS[@]}" -eq 0 ]; then
            echo "::error::No deployments found. Exiting workflow." >&2
            exit 1
          fi

          echo "deployment-matrix=${DEPLOYMENTS}" >> $GITHUB_OUTPUT
          echo "âœ… Found deployments: ${DEPLOYMENTS}"
      - name: Extract Docker Image Tag
        id: get-gateway-tag
        run: |
          GATEWAY_TAG=$(awk '/tyk-gateway:/ { in_gateway=1 }
                            in_gateway && /image:/ {
                              if (match($0, /:-v[0-9]+\.[0-9]+\.[0-9]+([-._a-zA-Z0-9]*)?/)) {
                                print substr($0, RSTART+2, RLENGTH-2)
                              }
                              in_gateway=0
                            }' deployments/tyk/docker-compose.yml | sort -u | head -n 1)

          if [[ -z "$GATEWAY_TAG" ]]; then
            echo "::error::GATEWAY_TAG is empty"
            exit 1
          fi

          if [[ ! "$GATEWAY_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-._a-zA-Z0-9]+)?$ ]]; then
            echo "::error::GATEWAY_TAG '$GATEWAY_TAG' is not in a valid semver format"
            exit 1
          fi

          echo "âœ… Extracted gateway tag: $GATEWAY_TAG"
          echo "gateway-tag=$GATEWAY_TAG" >> "$GITHUB_OUTPUT"

  # Run each deployment test in parallel
  test-deployments:
    needs: discover-deployments
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue with other tests even if one fails
      matrix:
        deployment: ${{ fromJson(needs.discover-deployments.outputs.deployment-matrix) }}

    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@v4

      - name: Set global env vars
        run: |
          echo "DEPLOYMENT_DIR=$(pwd)/deployments/${{ matrix.deployment }}" >> $GITHUB_ENV
          echo "BASE_DIR=$(pwd)" >> $GITHUB_ENV

      - name: Install websocat for tests
        run: |
          wget https://github.com/vi/websocat/releases/download/v1.14.0/websocat.x86_64-unknown-linux-musl
          chmod +x websocat.x86_64-unknown-linux-musl
          sudo mv websocat.x86_64-unknown-linux-musl /usr/local/bin/websocat

      - name: Set up environment
        run: |
          echo "::group::Preparing test logs"
          source "$(pwd)/scripts/test-common.sh"
          prepare_test_logs
          echo "::endgroup::"

          echo "::group::Defaulting to debug logs for Gateway and Dashboard"
          echo "GATEWAY_LOGLEVEL=debug" >> .env
          echo "DASHBOARD_LOGLEVEL=debug" >> .env
          echo "âœ… Gateway and Dashboard log levels set to debug ðŸ›"
          echo "::endgroup::"

          echo "::group::Setting licences"
          if [ -z "${{ secrets.DASH_LICENSE }}" ]; then
            echo "::error::DASH_LICENSE secret is not set or is empty." >&2
            exit 1
          fi
          if [ -z "${{ secrets.MDCB_LICENSE }}" ]; then
            echo "::error::MDCB_LICENSE secret is not set or is empty." >&2
            exit 1
          fi
          echo "âœ… DASHBOARD_LICENCE added to .env"
          echo "DASHBOARD_LICENCE=${{ secrets.DASH_LICENSE }}" >> .env
          echo "âœ… MDCB_LICENCE added to .env"
          echo "MDCB_LICENCE=${{ secrets.MDCB_LICENSE }}" >> .env
          echo "::endgroup::"

      - name: Cache Go Plugins
        uses: actions/cache@v4
        with:
          path: .bootstrap/plugin-cache/${{ needs.discover-deployments.outputs.gateway-tag }}
          key: ${{ runner.os }}-plugin-cache-${{ needs.discover-deployments.outputs.gateway-tag }}-${{ hashFiles('deployments/tyk/volumes/tyk-gateway/plugins/go/**/*') }}

      - name: Create deployment
        id: create-deployment
        run: |
          echo "Creating deployment: ${{ matrix.deployment }}"
          compose_argument=""

          echo "::group::Reading deployment manifest"
          if [ -f "${DEPLOYMENT_DIR}/deployment.json" ]; then
            compose_argument=$(jq -r '.composeArgument // empty' "${DEPLOYMENT_DIR}/deployment.json")
            echo "Compose argument set to: $compose_argument"
          else
            echo "No deployment manifest found"
          fi
          echo "::endgroup::"

          echo "::group::Bringing deployment up"
          if ./up.sh "${compose_argument:-${{ matrix.deployment }}}" --hide-progress --skip-hostname-check; then
            echo "âœ… Deployment created successfully"
          else
            echo "::error::Deployment creation failed for ${{ matrix.deployment }}"
            exit 1
          fi
          echo "::endgroup::"

      - name: Validate Tests
        id: validate-tests
        run: |
          source "$(pwd)/scripts/test-common.sh"

          echo "::group::Checking for Postman tests"
          if validate_postman_collection "${{ matrix.deployment }}" "${DEPLOYMENT_DIR}"; then
            echo "âœ… Found Postman tests"
            echo "postman-tests-found=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No Postman tests found"
            echo "postman-tests-found=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

          echo "::group::Checking for custom tests"
          if validate_test_scripts "${{ matrix.deployment }}" "${DEPLOYMENT_DIR}"; then
            echo "âœ… Found custom tests"
            echo "custom-tests-found=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No custom tests found"
            echo "custom-tests-found=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Run Postman Tests
        id: run-postman-tests
        if: steps.validate-tests.outputs.postman-tests-found == 'true'
        continue-on-error: true
        run: |
          source "$(pwd)/scripts/test-common.sh"

          if run_postman_test "${{ matrix.deployment }}" "${DEPLOYMENT_DIR}"; then
            echo "âœ… Postman tests passed"
          else
            echo "âŒ Postman tests failed"
          fi

          strip_control_chars "logs/postman.log"

      - name: Run Custom Tests
        id: run-custom-tests
        if: steps.validate-tests.outputs.custom-tests-found == 'true'
        continue-on-error: true
        run: |
          source "$(pwd)/scripts/test-common.sh"

          # Run custom tests
          if run_test_scripts "${{ matrix.deployment }}" "${DEPLOYMENT_DIR}"; then
            echo "âœ… Custom tests passed"
          else
            echo "âŒ Custom tests failed"
          fi

      - name: Capture Container Logs
        if: always()
        run: |
          source "$(pwd)/scripts/test-common.sh"

          capture_container_logs ${{ matrix.deployment }}

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.deployment }}
          path: logs/

  # Collect test results and summarize
  summarize-results:
    needs: [ test-deployments ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@v4

      - name: Summarize test results
        run: |
          echo "## Test Results Summary" > summary.md
          echo "" >> summary.md
          echo "| Deployment | Postman Test Status | Custom Test Status | Deployment Status |" >> summary.md
          echo "|------------|--------------------|-------------------|-------------------|" >> summary.md

          for deployment in ${{ fromJson(needs.test-deployments.outputs.deployment-matrix) }}; do
            # Retrieve the outcomes for this deployment from outputs
            deployment_status="âŒ Deployment creation failed"
            if [[ "${{ needs.test-deployments.outputs['create-deployment-' + deployment + '-outcome'] }}" == "success" ]]; then
              deployment_status="âœ… Deployment created successfully"
            fi

            # Check if Postman tests were found and passed
            postman_status="âŒ Postman tests failed"
            if [[ "${{ needs.test-deployments.outputs['postman-tests-found-' + deployment] }}" == "true" ]]; then
              postman_status="âœ… Postman tests passed"
            fi

            # Check if custom tests were found and passed
            custom_tests_status="âŒ Custom tests failed"
            if [[ "${{ needs.test-deployments.outputs['custom-tests-found-' + deployment] }}" == "true" ]]; then
              custom_tests_status="âœ… Custom tests passed"
            fi

            # Write the results for the current deployment
            echo "| $deployment | $postman_status | $custom_tests_status | $deployment_status |" >> summary.md
          done

          cat summary.md

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: summary.md
